name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Publish TempBridge
      run: |
        dotnet publish TempBridge/TempBridge.csproj -c Release -r win-x64 --self-contained true -p:PublishSingleFile=true -o dist/TempBridge

    - name: Prepare Skin Structure
      run: |
        New-Item -ItemType Directory -Force -Path staging/Skins/HalfLifeMonitoring
        Copy-Item "HalfLifeMonitoring.ini" -Destination "staging/Skins/HalfLifeMonitoring/"
        Copy-Item "HalfLifeMonitoring.png" -Destination "staging/Skins/HalfLifeMonitoring/"
        Copy-Item -Recurse "@Resources" -Destination "staging/Skins/HalfLifeMonitoring/"
        Copy-Item -Recurse "dist/TempBridge" -Destination "staging/Skins/HalfLifeMonitoring/"
        
        # Copy scripts to root of skin for easy access
        Copy-Item "TempBridge/install.bat" -Destination "staging/Skins/HalfLifeMonitoring/TempBridge/"
        Copy-Item "TempBridge/uninstall.bat" -Destination "staging/Skins/HalfLifeMonitoring/TempBridge/"

    - name: Create RMSKIN.ini
      run: |
        $version = "${{ github.ref_name }}".TrimStart('v')
        $content = @"
        [rmskin]
        Name=HalfLife Monitoring
        Author=Kaic
        Version=$version
        LoadType=Skin
        Load=HalfLifeMonitoring\HalfLifeMonitoring.ini
        MinimumRainmeter=4.5.0
        MinimumWindows=10.0
        "@
        Set-Content -Path staging/RMSKIN.ini -Value $content

    - name: Create .rmskin Package
      run: |
        $version = "${{ github.ref_name }}".TrimStart('v')
        $packageName = "HalfLifeMonitoring_$version.rmskin"
        Compress-Archive -Path staging/* -DestinationPath $packageName
        echo "PACKAGE_NAME=$packageName" >> $env:GITHUB_ENV

    - name: Create Release and Upload Assets
      env:
        GITHUB_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
      run: |
        # Create the GitHub release (the .rmskin package is already in $PACKAGE_NAME)
        gh release create "${{ github.ref_name }}" "${{ env.PACKAGE_NAME }}" --generate-notes
        # Upload TempBridge binaries and installer scripts
        gh release upload "${{ github.ref_name }}" "dist/TempBridge/TempBridge.exe" "dist/TempBridge/install.bat" "dist/TempBridge/uninstall.bat" --clobber
        # Upload the .rmskin package (already attached via create, but ensure it's present)
        gh release upload "${{ github.ref_name }}" "${{ env.PACKAGE_NAME }}" --clobber
        gh release upload "${{ github.ref_name }}" "dist/TempBridge/TempBridge.exe" "dist/TempBridge/install.bat" "dist/TempBridge/uninstall.bat" --clobber
